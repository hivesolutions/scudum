#!/bin/sh
# -*- coding: utf-8 -*-

export DATA_ORIGIN=${DATA_ORIGIN-//ipv4.files.hive/data}
export DATA_TARGET=${DATA_TARGET-/data}
export DATA_USERNAME=${DATA_USERNAME-bot_admin}
export DATA_PASSWORD=${DATA_PASSWORD-anonymous}
export ARMOR_SERVER=${ARMOR_SERVER-netius}
export ARMOR_HOST=${ARMOR_HOST-0.0.0.0}
export ARMOR_PORT=${ARMOR_PORT-8080}
export ARMOR_SESSION=${ARMOR_SESSION-memory}
export ARMOR_ADAPTER=${ARMOR_ADAPTER-tiny}
export ARMOR_TINY_PATH=${ARMOR_TINY_PATH-$DATA_TARGET/tiny/armor.json}

set -e

source /etc/environ

# Retry function: retries a command up to MAX_RETRIES times with RETRY_DELAY
# seconds between attempts, allows for a command to fail and be retried.
retry() {
    local max_retries=${MAX_RETRIES:-10}
    local retry_delay=${RETRY_DELAY:-30}
    local attempt=1

    until "$@"; do
        if [ $attempt -ge $max_retries ]; then
            echo "Command failed after $max_retries attempts: $*"
            return 1
        fi
        echo "Attempt $attempt failed. Retrying in $retry_delay seconds..."
        sleep $retry_delay
        attempt=$((attempt + 1))
    done
}

mkdir -p $DATA_TARGET && retry mount -t cifs -o vers=1.0,username=$DATA_USERNAME,password=$DATA_PASSWORD $DATA_ORIGIN $DATA_TARGET

retry pip install --quiet netius tinydb armord

SERVER=$ARMOR_SERVER \
HOST=$ARMOR_HOST \
PORT=$ARMOR_PORT \
SESSION=$ARMOR_SESSION \
ADAPTER=$ARMOR_ADAPTER \
TINY_PATH=$ARMOR_TINY_PATH \
armord < /dev/null &> /var/log/armord.out.log &
